<?php
/**
 * „Ç∑„Çπ„ÉÜ„É†ÂÅ•ÂÖ®ÊÄßÁ¢∫Ë™ç„ÉÑ„Éº„É´
 * Ê†πÊú¨Ëß£Ê±∫Âæå„ÅÆÂãï‰ΩúÁ¢∫Ë™çÁî®
 */

// Ë®≠ÂÆöË™≠„ÅøËæº„Åø
require_once '../config/database.php';
require_once '../classes/Database.php';
require_once '../classes/DatabaseFactory.php';

header('Content-Type: text/html; charset=utf-8');
?>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç∑„Çπ„ÉÜ„É†ÂÅ•ÂÖ®ÊÄß„ÉÅ„Çß„ÉÉ„ÇØ - SmileyÈÖçÈ£ü„Ç∑„Çπ„ÉÜ„É†</title>
    <style>
        body { 
            font-family: 'Helvetica Neue', Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #333;
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 40px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
        }
        h1 {
            color: #2E8B57;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }
        h2 {
            color: #2E8B57;
            border-bottom: 2px solid #2E8B57;
            padding-bottom: 10px;
            margin-top: 40px;
        }
        .status-card {
            background: #f8f9fa;
            border-left: 4px solid #2E8B57;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .status-success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .status-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        .status-error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 20px 0;
            background: white;
        }
        th, td { 
            padding: 12px; 
            text-align: left; 
            border-bottom: 1px solid #ddd; 
        }
        th { 
            background-color: #2E8B57; 
            color: white;
            font-weight: bold; 
        }
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge-success { background: #28a745; color: white; }
        .badge-danger { background: #dc3545; color: white; }
        .badge-warning { background: #ffc107; color: #333; }
        .badge-info { background: #17a2b8; color: white; }
        .icon { font-size: 1.5em; margin-right: 10px; }
        .action-buttons {
            text-align: center;
            margin: 30px 0;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            margin: 0 10px;
            border: none;
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #2E8B57;
            color: white;
        }
        .btn-primary:hover {
            background: #245A41;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üç± „Ç∑„Çπ„ÉÜ„É†ÂÅ•ÂÖ®ÊÄß„ÉÅ„Çß„ÉÉ„ÇØ</h1>
        
        <?php
        try {
            // „Ç∑„Çπ„ÉÜ„É†ÂÅ•ÂÖ®ÊÄß„ÉÅ„Çß„ÉÉ„ÇØÂÆüË°å
            $healthCheck = DatabaseFactory::systemHealthCheck();
            $overallHealth = $healthCheck['success'];
            
            // ÂÖ®‰Ωì„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
            $statusClass = $overallHealth ? 'status-success' : 'status-error';
            $statusIcon = $overallHealth ? '‚úÖ' : '‚ùå';
            $statusMessage = $overallHealth ? '„Ç∑„Çπ„ÉÜ„É†„ÅØÊ≠£Â∏∏„Å´Âãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„Åô' : '„Ç∑„Çπ„ÉÜ„É†„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô';
            ?>
            
            <div class="status-card <?= $statusClass ?>">
                <h2><?= $statusIcon ?> Á∑èÂêà„Çπ„ÉÜ„Éº„Çø„Çπ</h2>
                <p><strong><?= $statusMessage ?></strong></p>
                <p>„ÉÅ„Çß„ÉÉ„ÇØÂÆüË°åÊôÇÂàª: <?= $healthCheck['timestamp'] ?></p>
            </div>
            
            <h2>üìä Ë©≥Á¥∞„ÉÅ„Çß„ÉÉ„ÇØÁµêÊûú</h2>
            
            <!-- „Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂ö -->
            <div class="status-card <?= $healthCheck['connection_info']['success'] ? 'status-success' : 'status-error' ?>">
                <h3><span class="icon">üîó</span>„Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂ö</h3>
                <p><strong>„Çπ„ÉÜ„Éº„Çø„Çπ:</strong> 
                    <span class="badge <?= $healthCheck['connection_info']['success'] ? 'badge-success' : 'badge-danger' ?>">
                        <?= $healthCheck['connection_info']['success'] ? 'Êé•Á∂öÊàêÂäü' : 'Êé•Á∂öÂ§±Êïó' ?>
                    </span>
                </p>
                <p><strong>„É°„ÉÉ„Çª„Éº„Ç∏:</strong> <?= htmlspecialchars($healthCheck['connection_info']['message']) ?></p>
                <p><strong>Áí∞Â¢É:</strong> <span class="badge badge-info"><?= $healthCheck['connection_info']['environment'] ?></span></p>
            </div>
            
            <!-- „ÉÜ„Éº„Éñ„É´Áä∂Ê≥Å -->
            <div class="status-card <?= $healthCheck['tables_info']['success'] ? 'status-success' : 'status-warning' ?>">
                <h3><span class="icon">üóÑÔ∏è</span>„Éá„Éº„Çø„Éô„Éº„Çπ„ÉÜ„Éº„Éñ„É´</h3>
                <p><strong>„Çπ„ÉÜ„Éº„Çø„Çπ:</strong> 
                    <span class="badge <?= $healthCheck['tables_info']['success'] ? 'badge-success' : 'badge-warning' ?>">
                        <?= $healthCheck['tables_info']['existing_tables'] ?>/<?= $healthCheck['tables_info']['total_required'] ?> „ÉÜ„Éº„Éñ„É´Â≠òÂú®
                    </span>
                </p>
                
                <!-- „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº -->
                <?php 
                $percentage = ($healthCheck['tables_info']['existing_tables'] / $healthCheck['tables_info']['total_required']) * 100;
                ?>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: <?= $percentage ?>%"></div>
                </div>
                <p><?= round($percentage, 1) ?>% ÂÆå‰∫Ü</p>
                
                <?php if (!empty($healthCheck['tables_info']['missing_tables'])): ?>
                <p><strong>‰∏çË∂≥„ÉÜ„Éº„Éñ„É´:</strong> <?= implode(', ', $healthCheck['tables_info']['missing_tables']) ?></p>
                <?php endif; ?>
                
                <!-- „ÉÜ„Éº„Éñ„É´Ë©≥Á¥∞ -->
                <table>
                    <tr><th>„ÉÜ„Éº„Éñ„É´Âêç</th><th>Áä∂ÊÖã</th></tr>
                    <?php foreach ($healthCheck['tables_info']['table_status'] as $table => $exists): ?>
                    <tr>
                        <td><?= htmlspecialchars($table) ?></td>
                        <td>
                            <span class="badge <?= $exists ? 'badge-success' : 'badge-danger' ?>">
                                <?= $exists ? 'Â≠òÂú®' : '‰∏çÂ≠òÂú®' ?>
                            </span>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </table>
            </div>
            
            <!-- Ë®≠ÂÆöÁä∂Ê≥Å -->
            <div class="status-card <?= $healthCheck['health_check']['configuration'] ? 'status-success' : 'status-error' ?>">
                <h3><span class="icon">‚öôÔ∏è</span>„Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö</h3>
                <table>
                    <tr><th>Ë®≠ÂÆöÈ†ÖÁõÆ</th><th>ÂÄ§</th><th>Áä∂ÊÖã</th></tr>
                    <tr>
                        <td>„Éá„Éº„Çø„Éô„Éº„Çπ„Éõ„Çπ„Éà</td>
                        <td><?= defined('DB_HOST') ? DB_HOST : 'Êú™ÂÆöÁæ©' ?></td>
                        <td><span class="badge <?= defined('DB_HOST') ? 'badge-success' : 'badge-danger' ?>"><?= defined('DB_HOST') ? 'OK' : 'NG' ?></span></td>
                    </tr>
                    <tr>
                        <td>„Éá„Éº„Çø„Éô„Éº„ÇπÂêç</td>
                        <td><?= defined('DB_NAME') ? DB_NAME : 'Êú™ÂÆöÁæ©' ?></td>
                        <td><span class="badge <?= defined('DB_NAME') ? 'badge-success' : 'badge-danger' ?>"><?= defined('DB_NAME') ? 'OK' : 'NG' ?></span></td>
                    </tr>
                    <tr>
                        <td>„Éá„Éº„Çø„Éô„Éº„Çπ„É¶„Éº„Ç∂„Éº</td>
                        <td><?= defined('DB_USER') ? DB_USER : 'Êú™ÂÆöÁæ©' ?></td>
                        <td><span class="badge <?= defined('DB_USER') ? 'badge-success' : 'badge-danger' ?>"><?= defined('DB_USER') ? 'OK' : 'NG' ?></span></td>
                    </tr>
                    <tr>
                        <td>„Éë„Çπ„ÉØ„Éº„ÉâË®≠ÂÆö</td>
                        <td><?= defined('DB_PASS') && !empty(DB_PASS) ? 'Ë®≠ÂÆöÊ∏à„Åø' : 'Êú™Ë®≠ÂÆö' ?></td>
                        <td><span class="badge <?= defined('DB_PASS') && !empty(DB_PASS) ? 'badge-success' : 'badge-danger' ?>"><?= defined('DB_PASS') && !empty(DB_PASS) ? 'OK' : 'NG' ?></span></td>
                    </tr>
                    <tr>
                        <td>Áí∞Â¢É</td>
                        <td><?= defined('ENVIRONMENT') ? ENVIRONMENT : 'Êú™ÂÆöÁæ©' ?></td>
                        <td><span class="badge badge-info"><?= defined('ENVIRONMENT') ? ENVIRONMENT : 'unknown' ?></span></td>
                    </tr>
                    <tr>
                        <td>„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ</td>
                        <td><?= defined('DEBUG_MODE') ? (DEBUG_MODE ? 'ON' : 'OFF') : 'Êú™ÂÆöÁæ©' ?></td>
                        <td><span class="badge <?= defined('DEBUG_MODE') && DEBUG_MODE ? 'badge-warning' : 'badge-success' ?>"><?= defined('DEBUG_MODE') && DEBUG_MODE ? 'ON' : 'OFF' ?></span></td>
                    </tr>
                </table>
            </div>
            
            <!-- „Ç∑„Çπ„ÉÜ„É†ÊÉÖÂ†± -->
            <?php
            $dbInfo = DatabaseFactory::getDatabaseInfo();
            if ($dbInfo['success']):
            ?>
            <div class="status-card status-success">
                <h3><span class="icon">üìã</span>„Ç∑„Çπ„ÉÜ„É†ÊÉÖÂ†±</h3>
                <table>
                    <tr><th>È†ÖÁõÆ</th><th>ÂÄ§</th></tr>
                    <tr><td>MySQL „Éê„Éº„Ç∏„Éß„É≥</td><td><?= htmlspecialchars($dbInfo['mysql_version']) ?></td></tr>
                    <tr><td>„Éá„Éº„Çø„Éô„Éº„ÇπÂêç</td><td><?= htmlspecialchars($dbInfo['database_name']) ?></td></tr>
                    <tr><td>ÊñáÂ≠ó„Çª„ÉÉ„Éà</td><td><?= htmlspecialchars($dbInfo['charset']) ?></td></tr>
                    <tr><td>PHP „Éê„Éº„Ç∏„Éß„É≥</td><td><?= PHP_VERSION ?></td></tr>
                    <tr><td>„É°„É¢„É™Âà∂Èôê</td><td><?= ini_get('memory_limit') ?></td></tr>
                    <tr><td>„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏äÈôê</td><td><?= ini_get('upload_max_filesize') ?></td></tr>
                    <tr><td>ÂÆüË°åÊôÇÈñìÂà∂Èôê</td><td><?= ini_get('max_execution_time') ?>Áßí</td></tr>
                </table>
            </div>
            <?php endif; ?>
            
            <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
            <div class="action-buttons">
                <?php if ($overallHealth): ?>
                    <a href="../pages/csv_import.php" class="btn btn-primary">üìÅ CSV„Ç§„É≥„Éù„Éº„Éà„ÇíÈñãÂßã</a>
                    <a href="../index.php" class="btn btn-primary">üè† „É°„Ç§„É≥„Ç∑„Çπ„ÉÜ„É†„Å∏</a>
                <?php else: ?>
                    <button onclick="location.reload()" class="btn btn-secondary">üîÑ ÂÜç„ÉÅ„Çß„ÉÉ„ÇØ</button>
                    <?php if (!$healthCheck['tables_info']['success']): ?>
                    <a href="https://<?= $_SERVER['HTTP_HOST'] ?>/phpmyadmin" target="_blank" class="btn btn-secondary">üîß phpMyAdmin „Åß‰øÆÂæ©</a>
                    <?php endif; ?>
                <?php endif; ?>
            </div>
            
            <!-- „Éà„É©„Éñ„É´„Ç∑„É•„Éº„ÉÜ„Ç£„É≥„Ç∞ -->
            <?php if (!$overallHealth): ?>
            <div class="status-card status-warning">
                <h3><span class="icon">üõ†Ô∏è</span>„Éà„É©„Éñ„É´„Ç∑„É•„Éº„ÉÜ„Ç£„É≥„Ç∞</h3>
                
                <?php if (!$healthCheck['connection_info']['success']): ?>
                <h4>„Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂ö„ÅÆÂïèÈ°å</h4>
                <ol>
                    <li>„Éá„Éº„Çø„Éô„Éº„ÇπË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>
                    <li>MySQL„Çµ„Éº„Éê„Éº„ÅåÁ®ºÂÉç„Åó„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>
                    <li>„É¶„Éº„Ç∂„ÉºÊ®©Èôê„ÅåÊ≠£„Åó„ÅèË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>
                </ol>
                <div class="code-block">
# „Ç®„ÉÉ„ÇØ„Çπ„Çµ„Éº„Éê„Éº„Åß„ÅÆÁ¢∫Ë™çÊâãÈ†Ü
1. „Çµ„Éº„Éê„Éº„Éë„Éç„É´ ‚Üí MySQLË®≠ÂÆö
2. „Éá„Éº„Çø„Éô„Éº„ÇπÂêç: <?= defined('DB_NAME') ? DB_NAME : '[„Éá„Éº„Çø„Éô„Éº„ÇπÂêç]' ?>
3. „É¶„Éº„Ç∂„ÉºÂêç: <?= defined('DB_USER') ? DB_USER : '[„É¶„Éº„Ç∂„ÉºÂêç]' ?>
4. „É¶„Éº„Ç∂„Éº„Åå„Éá„Éº„Çø„Éô„Éº„Çπ„Å´Á¥ê‰ªò„Åë„Çâ„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
                </div>
                <?php endif; ?>
                
                <?php if (!$healthCheck['tables_info']['success']): ?>
                <h4>„ÉÜ„Éº„Éñ„É´„ÅÆÂïèÈ°å</h4>
                <p>‰ª•‰∏ã„ÅÆ„ÉÜ„Éº„Éñ„É´„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇphpMyAdmin„Åß„ÉÜ„Éº„Éñ„É´‰ΩúÊàêSQL„ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö</p>
                <div class="code-block">
‰∏çË∂≥„ÉÜ„Éº„Éñ„É´: <?= implode(', ', $healthCheck['tables_info']['missing_tables']) ?>
                </div>
                <?php endif; ?>
            </div>
            <?php endif; ?>
            
            <?php
        } catch (Exception $e) {
            ?>
            <div class="status-card status-error">
                <h2>‚ùå „Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº</h2>
                <p><strong>„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏:</strong> <?= htmlspecialchars($e->getMessage()) ?></p>
                <p><strong>„Éï„Ç°„Ç§„É´:</strong> <?= htmlspecialchars($e->getFile()) ?></p>
                <p><strong>Ë°å:</strong> <?= $e->getLine() ?></p>
                
                <h3>ÂØæÂá¶Ê≥ï</h3>
                <ol>
                    <li>config/database.php „Éï„Ç°„Ç§„É´„ÅåÊ≠£„Åó„ÅèÈÖçÁΩÆ„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç</li>
                    <li>classes/Database.php „Éï„Ç°„Ç§„É´„ÅåÊ≠£„Åó„ÅèÈÖçÁΩÆ„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç</li>
                    <li>classes/DatabaseFactory.php „Éï„Ç°„Ç§„É´„ÅåÊ≠£„Åó„ÅèÈÖçÁΩÆ„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç</li>
                    <li>„Éï„Ç°„Ç§„É´„ÅÆÊ®©Èôê„ÅåÊ≠£„Åó„ÅèË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç</li>
                </ol>
            </div>
            <?php
        }
        ?>
        
        <div style="text-align: center; margin-top: 40px; color: #6c757d;">
            <p>SmileyÈÖçÈ£ü‰∫ãÊ•≠ Ë´ãÊ±ÇÊõ∏ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† v<?= defined('SYSTEM_VERSION') ? SYSTEM_VERSION : '1.0.0' ?></p>
            <p>¬© 2025 SmileyÈÖçÈ£ü‰∫ãÊ•≠. All rights reserved.</p>
        </div>
    </div>
</body>
</html>
