name: Deploy to Test Environment (FTP)

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  deploy-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, mysqli
        
    - name: Create deployment package
      run: |
        echo "ğŸ“¦ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œæˆä¸­..."
        
        # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        mkdir -p uploads temp logs cache
        
        # .htaccessãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
        cat > .htaccess << 'EOF'
        RewriteEngine On
        RewriteCond %{HTTPS} off
        RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
        Options -Indexes
        <Files ~ "^\.">
            Order allow,deny
            Deny from all
        </Files>
        <Files ~ "config\.php$">
            Order allow,deny
            Deny from all
        </Files>
        <Directory "uploads">
            php_flag engine off
            AddType text/plain .php .php3 .phtml .pht
        </Directory>
        php_value upload_max_filesize 10M
        php_value post_max_size 10M
        php_value max_execution_time 300
        php_value memory_limit 256M
        EOF
        
        echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆå®Œäº†"
        
    - name: Deploy to Test Server via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        server-dir: ${{ secrets.FTP_SERVER_DIR }}
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.github/**
          **/tests/**
          **/.env
          **/README.md
          **/deploy-package/**
        
    - name: Verify deployment
      run: |
        echo "ğŸŒ ãƒ†ã‚¹ãƒˆç’°å¢ƒURL: https://twinklemark.xsrv.jp/Smiley/meal-delivery/billing-system/"
        echo "âœ… FTPãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
        
    - name: Send success notification
      if: success()
      run: |
        echo "ğŸ‰ ãƒ†ã‚¹ãƒˆç’°å¢ƒã¸ã®FTPãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã—ã¾ã—ãŸï¼"
        echo "ğŸ“ ç¢ºèªURL: https://twinklemark.xsrv.jp/Smiley/meal-delivery/billing-system/"
        echo "ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª"
        
    - name: Send failure notification  
      if: failure()
      run: |
        echo "âŒ ãƒ†ã‚¹ãƒˆç’°å¢ƒã¸ã®FTPãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã—ãŸ"
        echo "ğŸ” ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦FTPè¨­å®šã‚’è¦‹ç›´ã—ã¦ãã ã•ã„"
