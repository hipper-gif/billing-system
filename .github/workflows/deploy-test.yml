name: Deploy to Test Environment (FTP)

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:  # 手動実行も可能

jobs:
  deploy-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, mysqli
        
    - name: Create deployment package
      run: |
        echo "📦 デプロイパッケージを作成中..."
        
        # 必要なディレクトリを作成
        mkdir -p uploads temp logs cache
        
        # .htaccessファイルを作成
        cat > .htaccess << 'EOF'
        RewriteEngine On
        RewriteCond %{HTTPS} off
        RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
        Options -Indexes
        <Files ~ "^\.">
            Order allow,deny
            Deny from all
        </Files>
        <Files ~ "config\.php$">
            Order allow,deny
            Deny from all
        </Files>
        <Directory "uploads">
            php_flag engine off
            AddType text/plain .php .php3 .phtml .pht
        </Directory>
        php_value upload_max_filesize 10M
        php_value post_max_size 10M
        php_value max_execution_time 300
        php_value memory_limit 256M
        EOF
        
        echo "✅ デプロイパッケージ作成完了"
        
    - name: Deploy to Test Server via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        server-dir: ${{ secrets.FTP_SERVER_DIR }}
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.github/**
          **/tests/**
          **/.env
          **/README.md
          **/deploy-package/**
        
    - name: Verify deployment
      run: |
        echo "🌐 テスト環境URL: https://twinklemark.xsrv.jp/Smiley/meal-delivery/billing-system/"
        echo "✅ FTPデプロイ完了"
        
    - name: Send success notification
      if: success()
      run: |
        echo "🎉 テスト環境へのFTPデプロイが成功しました！"
        echo "📍 確認URL: https://twinklemark.xsrv.jp/Smiley/meal-delivery/billing-system/"
        echo "📝 次のステップ: データベース接続確認"
        
    - name: Send failure notification  
      if: failure()
      run: |
        echo "❌ テスト環境へのFTPデプロイが失敗しました"
        echo "🔍 ログを確認してFTP設定を見直してください"
